<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>1-to-1 WebRTC Demo</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --primary:#5e2ca5; 
  --primary-light:#9b59b6;
  --bg:#fff;
  --text:#111;
  --panel-bg:#f8f8f8;
  --accent:#5e2ca5;
  --accent-dark:#3d1f6a;
}

body{
  margin:0;
  font-family:'Segoe UI',Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  flex-direction:column;
  height:100vh;
  overflow:hidden;
}

header{
  padding:14px 20px;
  background:var(--primary);
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 4px 8px rgba(0,0,0,0.1);
}
header h2{margin:0;font-size:1.1rem;font-weight:600}
#timer{
  background:rgba(255,255,255,0.2);
  padding:6px 14px;
  border-radius:14px;
  font-weight:600;
  font-size:0.95rem;
}

.ticker{
  background:var(--primary-light);
  color:#fff;
  padding:8px 12px;
  white-space:nowrap;
  overflow:hidden;
  font-weight:500;
  font-size:0.9rem;
}
.ticker-content{
  display:inline-block;
  animation:scroll 20s linear infinite;
}
@keyframes scroll{
  0%{transform:translateX(0)}
  100%{transform:translateX(-50%)}
}

.main{
  flex:1;
  display:flex;
  padding:18px;
  gap:20px;
  align-items:flex-start;
  justify-content:center;
  background:#fff;
}

.video-container{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:16px;
  align-items:center;
  justify-content:center;
  width:100%;
}

video{
  background:#000;
  border-radius:14px;
  border:2px solid var(--accent);
  box-shadow:0 6px 20px rgba(0,0,0,0.12);
  width:48%;
  height:55vh;
  object-fit:cover;
}

.controls{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:18px;
  display:flex;
  gap:14px;
}
.controls button{
  width:56px;
  height:56px;
  border-radius:50%;
  border:none;
  background:var(--primary);
  color:#fff;
  font-size:18px;
  cursor:pointer;
  box-shadow:0 6px 15px rgba(0,0,0,0.2);
  transition:all 0.2s;
}
.controls button:hover{transform:scale(1.1);}
.controls button#disconnect{background:#d93025;}

.reaction-panel{
  position:absolute;
  bottom:100px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:10px;
  background:rgba(94,44,165,0.12);
  padding:6px 14px;
  border-radius:40px;
  backdrop-filter:blur(6px);
}
.reaction-panel button{
  font-size:22px;
  background:transparent;
  border:none;
  cursor:pointer;
}

.reaction{
  position:absolute;
  font-size:36px;
  animation:floatUp 2.4s ease-out forwards;
  pointer-events:none;
  text-shadow:0 0 6px var(--accent-dark);
}
@keyframes floatUp{
  0%{opacity:1;transform:translateY(0) scale(1)}
  50%{opacity:0.9;transform:translateY(-80px) scale(1.15)}
  100%{opacity:0;transform:translateY(-160px) scale(.8)}
}

.side{
  width:340px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.side .panel{
  background:var(--panel-bg);
  padding:14px;
  border-radius:12px;
  border:1px solid rgba(94,44,165,0.15);
  box-shadow:0 3px 12px rgba(0,0,0,0.06);
}

.chat-messages{
  height:46vh;
  overflow:auto;
  padding:8px;
  display:flex;
  flex-direction:column;
  gap:8px;
  background:#fff;
  border-radius:8px;
  border:1px solid rgba(0,0,0,0.08);
}

.msg.you{
  align-self:flex-end;
  background:var(--primary-light);
  color:#111;
  padding:8px 12px;
  border-radius:12px;
}
.msg.other{
  align-self:flex-start;
  background:#f1e6ff;
  color:#111;
  padding:8px 12px;
  border-radius:12px;
}

.room-row{
  display:flex;
  gap:10px;
  align-items:center;
}
input[type=text]{
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,0.15);
  flex:1;
}
button.primary{
  padding:10px 16px;
  border-radius:10px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s;
}
button.primary:hover{background:var(--primary-dark);}

@media (max-width:900px){
  .main{flex-direction:column;align-items:center;}
  video{width:90%;height:40vh;}
  .side{width:95%;}
}
.video-container {
  display: flex;
  flex-direction: row;
  justify-content: center;
  gap: 16px;
}
.video-container video {
  width: 48%;
  height: 55vh;
}

</style>
</head>
<body>

<header>
  <h2>Welcome to Dr Shaveta‚Äôs Therapy ‚Äî 1:1 Room</h2>
  <div id="timer">00:00</div>
</header>

<div class="main">
 <div class="video-container">
  
  <!-- Local video baad mein (right side) -->
  <video id="localVideo" autoplay playsinline muted></video>
  <!-- Remote video pehle (left side) -->
  <video id="remoteVideo" autoplay playsinline></video>



</div>


  <div class="side">
    <div class="panel">
      <div class="room-row">
        <input type="text" id="roomInput" placeholder="Room name" value="testroom">
        <button class="primary" id="joinBtn">Join</button>
      </div>
      <div style="margin-top:8px;font-size:0.9rem;color:rgba(0,0,0,0.6)">
        Status: <span id="status">Not connected</span>
      </div>
    </div>

    <div class="panel">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="micBtn"><i class="fas fa-microphone"></i></button>
        <button id="camBtn"><i class="fas fa-video"></i></button>
        <button id="screenBtn"><i class="fas fa-desktop"></i></button>
        <button id="handBtn"><i class="fas fa-hand-paper"></i></button>
      </div>
      <div style="display:flex;gap:8px">
        <button id="reactionToggle" class="primary">Reactions</button>
        <button id="disconnect" class="primary" style="background:#d93025">Disconnect</button>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:700;margin-bottom:8px">Chat</div>
      <div class="chat-messages" id="chatMessages"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="chatInput" type="text" placeholder="Type message...">
        <button id="sendChat" class="primary">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Controls -->
<div class="controls" aria-hidden style="margin-top:+260px; position:absolute;">
  <button id="micCtl"><i class="fas fa-microphone"></i></button>
  <button id="camCtl"><i class="fas fa-video"></i></button>
  <button id="screenCtl"><i class="fas fa-desktop"></i></button>
  <button id="emojiBtn"><i class="fas fa-smile"></i></button> <!-- Emoji Button -->
  <button id="disconnectCtl" style="background:#d93025"><i class="fas fa-phone-slash"></i></button>
</div>

<!-- ‚úÖ Reaction Panel -->
<div class="reaction-panel" id="reaction-panel">
  <button onclick="sendReaction('üëè')">üëè</button>
  <button onclick="sendReaction('üòÇ')">üòÇ</button>
  <button onclick="sendReaction('üëç')">üëç</button>
  <button onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
  <button onclick="sendReaction('üéâ')">üéâ</button>
</div>

<style>
.controls button {
  background: #444;
  border: none;
  color: #fff;
  font-size: 20px;
  padding: 10px 12px;
  border-radius: 50%;
  margin: 0 5px;
  cursor: pointer;
  margin-top: -140px;
}

.controls button:hover {
  background: #666;
}

.reaction-panel {
  position: absolute;
  bottom: 60px; /* controls ke upar show hoga */
  left: 50%;
  transform: translateX(-50%);
  background: #222;
  padding: 8px 12px;
  border-radius: 12px;
  display: none; /* hidden by default */
  gap: 6px;
}

.reaction-panel button {
  background: transparent;
  border: none;
  font-size: 22px;
  cursor: pointer;
}

.reaction-panel button:hover {
  transform: scale(1.2);
}
</style>

<script>
const emojiBtn = document.getElementById("emojiBtn");

// Dummy function (yaha aap apna reaction logic lagaoge)
function sendReaction(emoji) {
  alert("Reaction sent: " + emoji);
}
</script>

<!-- TICKER -->
  <div class="ticker">
    <div class="ticker-content">
      <i class="fa-solid fa-brain"></i> <strong>Hypnosis</strong> ‚Äì Release fears |
      <i class="fa-solid fa-people-arrows"></i> <strong>Couple Counseling</strong> ‚Äì Better bonding |
      <i class="fa-solid fa-moon"></i> <strong>Past Life Regression</strong> ‚Äì Heal trauma |
      <i class="fa-solid fa-leaf"></i> <strong>Deep Healing</strong> ‚Äì Emotional balance |
      <i class="fa-solid fa-face-meh-blank"></i> <strong>Overthinking</strong> ‚Äì Calm mind |
      <i class="fa-solid fa-heart-crack"></i> <strong>Negative Thoughts</strong> ‚Äì Build positivity |
      <i class="fa-solid fa-scroll"></i> <strong>Kundli Matching</strong> ‚Äì Compatibility check |
      <i class="fa-solid fa-ring"></i> <strong>Post-Divorce</strong> ‚Äì Fresh start |
      <i class="fa-solid fa-baby"></i> <strong>Post-Partum</strong> ‚Äì Support for mothers |
      <i class="fa-solid fa-music"></i> <strong>Sound Healing</strong> ‚Äì Stress relief |
      <i class="fa-solid fa-eye"></i> <strong>Tarot Reading</strong> ‚Äì Future clarity |
      <i class="fa-solid fa-spa"></i> <strong>Stress & Anxiety</strong> ‚Äì Find peace |
      <i class="fa-solid fa-child"></i> <strong>Inner Child</strong> ‚Äì Heal childhood wounds
    </div>
  </div>

<style>
.ticker {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #6f42c1; /* light purple */
  color: #fff;
  padding: 8px 0;
  overflow: hidden;
  z-index: 1000;
  font-family: "Segoe UI", sans-serif;
}

.ticker-content {
  display: inline-block;
  white-space: nowrap;
  padding-left: 100%;
  animation: ticker-scroll 20s linear infinite;
  font-size: 16px;
}

@keyframes ticker-scroll {
  0%   { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}
</style>

<!-- JS: Keep your existing WebRTC + signaling JS here -->
<script>
const video = document.getElementById('webcam');
const toggleCameraBtn = document.getElementById('toggleCamera');
const toggleMicBtn = document.getElementById('toggleMic');
const tooltip = document.querySelector(".tooltip");

let stream;
let currentVideoTrack;

async function startMedia() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    video.srcObject = stream;
    currentVideoTrack = stream.getVideoTracks()[0];
  } catch (err) {
    alert('Could not access webcam/mic: ' + err);
  }
}

toggleCameraBtn.addEventListener('click', () => {
  if (currentVideoTrack) {
    currentVideoTrack.enabled = !currentVideoTrack.enabled;
    toggleCameraBtn.textContent = currentVideoTrack.enabled ? 'üì∑' : 'üö´';
  }
});

toggleMicBtn.addEventListener('click', () => {
  if (stream) {
    const audioTrack = stream.getAudioTracks()[0];
    audioTrack.enabled = !audioTrack.enabled;
    toggleMicBtn.textContent = audioTrack.enabled ? 'üé§' : 'üîá';
  }
});

document.getElementById("gotItBtn").addEventListener("click", () => {
  tooltip.style.display = "none";
});

// ‚úÖ Join Button ‚Üí Redirect to call.html
document.getElementById("switchBtn").addEventListener("click", () => {
  const roomId = "default-room"; // Static room id (can make random also)
  window.location.href = `call.html?room=${roomId}`;
});

startMedia();
</script>
</body>
</html>

<script>
/* CONFIG */
const SIGNALING_SERVER = location.origin.replace(/^http/, 'ws'); 
const ICE_CONFIG = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

/* UI */
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const joinBtn = document.getElementById('joinBtn');
const roomInput = document.getElementById('roomInput');
const statusSpan = document.getElementById('status');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendChat = document.getElementById('sendChat');
const reactionPanel = document.getElementById('reaction-panel');
const reactionToggle = document.getElementById('reactionToggle');
const disconnectBtn = document.getElementById('disconnect');




/* START CAMERA/MIC */
async function startLocalMedia() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localVideo.srcObject = localStream;
  } catch(e){ alert('Cannot access camera/mic: '+e.message); }
}
startLocalMedia();

/* TIMER */
function startTimer(sec=0){
  timeSeconds=sec;
  if(timerInterval) clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    timeSeconds++;
    const m=Math.floor(timeSeconds/60).toString().padStart(2,'0');
    const s=(timeSeconds%60).toString().padStart(2,'0');
    timerEl.textContent=`${m}:${s}`;
  },1000);
}

/* JOIN ROOM */
joinBtn.onclick = async ()=>{
  if(joined) return;
  room = roomInput.value.trim() || 'default';
  ws = new WebSocket(SIGNALING_SERVER);

  ws.onopen = ()=>{
    statusSpan.textContent=`Joined room: ${room}`;
    ws.send(JSON.stringify({cmd:'join', room}));
    joined = true;
    startTimer(0);
  };

  ws.onmessage = async (ev)=>{
    const data = JSON.parse(ev.data);
    if(data.cmd==='joined'){
      if(data.participants===2){ isOfferer=true; statusSpan.textContent='Peer present, creating offer...'; await maybeStartPeer(true); }
      else statusSpan.textContent='Waiting for peer...';
    } else if(data.cmd==='peer-joined'){
      isOfferer=false; statusSpan.textContent='Peer joined, preparing connection...'; await maybeStartPeer(false);
    } else if(data.cmd==='offer'){
      await ensurePC();
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      ws.send(JSON.stringify({cmd:'answer', sdp:pc.localDescription}));
    } else if(data.cmd==='answer'){
      await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
    } else if(data.cmd==='ice' && data.candidate){
      await pc.addIceCandidate(data.candidate);
    } else if(data.cmd==='peer-left'){
      statusSpan.textContent='Peer left';
      cleanupPeer();
    } else if(data.cmd==='room_full'){
      alert('Room is full! Only 1-to-1 supported.');
    } else if(data.cmd==='chat'){
      appendChat('other', data.text);
    } else if(data.cmd==='reaction'){
      showFloatingReaction(data.emoji);
    }
  };

  ws.onerror = (e)=> console.error('WS error', e);
  ws.onclose = ()=> statusSpan.textContent='Disconnected from signaling server';
};

/* PEER CONNECTION */
async function ensurePC(){
  if(pc) return;
  pc = new RTCPeerConnection(ICE_CONFIG);
  if(localStream) localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.ontrack = (ev)=>{
    if(ev.streams && ev.streams[0]) remoteVideo.srcObject=ev.streams[0];
    else remoteVideo.srcObject = new MediaStream(ev.track?[ev.track]:[]);
  };
  pc.onicecandidate=(e)=>{
    if(e.candidate && ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({cmd:'ice', candidate:e.candidate}));
  };
  pc.onconnectionstatechange=()=>{
    if(pc.connectionState==='connected') statusSpan.textContent='In call (connected)';
    if(pc.connectionState==='disconnected' || pc.connectionState==='failed') statusSpan.textContent='Disconnected';
  };
}

async function maybeStartPeer(weShouldOffer){
  await ensurePC();
  if(weShouldOffer){
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    ws.send(JSON.stringify({cmd:'offer', sdp:pc.localDescription}));
  }
}

/* CHAT */
sendChat.onclick=()=>{
  const txt=chatInput.value.trim();
  if(!txt) return;
  appendChat('you', txt);
  if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({cmd:'chat', text:txt}));
  chatInput.value='';
};
function appendChat(who,text){
  const d=document.createElement('div');
  d.className='msg '+(who==='you'?'you':'other');
  d.textContent=text;
  chatMessages.appendChild(d);
  chatMessages.scrollTop=chatMessages.scrollHeight;
}
chatInput.addEventListener('keypress',(e)=>{if(e.key==='Enter') sendChat.click();});

/* REACTIONS */
reactionToggle.onclick = ()=>reactionPanel.style.display=(reactionPanel.style.display==='flex'?'none':'flex');
function sendReaction(emoji){
  showFloatingReaction(emoji);
  if(ws && ws.readyState===WebSocket.OPEN) ws.send(JSON.stringify({cmd:'reaction', emoji}));
}
function showFloatingReaction(emoji){
  const container=document.querySelector('.video-container');
  const el=document.createElement('div');
  el.className='reaction';
  el.textContent=emoji;
  const rect = container.getBoundingClientRect();
  el.style.left=(rect.width*(0.2+Math.random()*0.6))+'px';
  el.style.bottom=30+Math.random()*40+'px';
  container.appendChild(el);
  setTimeout(()=>el.remove(),2600);
}

/* CONTROLS */
let micOn=true, camOn=true, screenStream=null;
const micBtn=document.getElementById('micBtn'), camBtn=document.getElementById('camBtn'), screenBtn=document.getElementById('screenBtn'), handBtn=document.getElementById('handBtn');
micBtn.onclick=toggleMic; camBtn.onclick=toggleCam; screenBtn.onclick=shareScreen; handBtn.onclick=()=>alert('Raised hand ‚úã');
document.getElementById('micCtl').onclick=toggleMic;
document.getElementById('camCtl').onclick=toggleCam;
document.getElementById('screenCtl').onclick=shareScreen;
document.getElementById('disconnect').onclick=endCall;
document.getElementById('disconnectCtl').onclick=endCall;

function toggleMic(){ if(!localStream) return; micOn=!micOn; localStream.getAudioTracks().forEach(t=>t.enabled=micOn); micBtn.innerHTML=micOn?'<i class="fas fa-microphone"></i>':'<i class="fas fa-microphone-slash"></i>'; document.getElementById('micCtl').innerHTML=micOn?'<i class="fas fa-microphone"></i>':'<i class="fas fa-microphone-slash"></i>'; }
function toggleCam(){ if(!localStream) return; camOn=!camOn; localStream.getVideoTracks().forEach(t=>t.enabled=camOn); camBtn.innerHTML=camOn?'<i class="fas fa-video"></i>':'<i class="fas fa-video-slash"></i>'; document.getElementById('camCtl').innerHTML=camOn?'<i class="fas fa-video"></i>':'<i class="fas fa-video-slash"></i>'; }

async function shareScreen(){
  if(screenStream){ screenStream.getTracks().forEach(t=>t.stop()); screenStream=null; const sender=pc&&pc.getSenders().find(s=>s.track&&s.track.kind==='video'); if(sender&&localStream) sender.replaceTrack(localStream.getVideoTracks()[0]); localVideo.srcObject=localStream; return; }
  try{
    const s=await navigator.mediaDevices.getDisplayMedia({video:true});
    screenStream=s;
    localVideo.srcObject=s;
    if(pc){ const sender=pc.getSenders().find(s=>s.track&&s.track.kind==='video'); if(sender) sender.replaceTrack(s.getVideoTracks()[0]); }
    s.getVideoTracks()[0].onended=()=>{ if(localStream){ localVideo.srcObject=localStream; if(pc){ const sender=pc.getSenders().find(s=>s.track&&s.track.kind==='video'); if(sender) sender.replaceTrack(localStream.getVideoTracks()[0]); } screenStream=null; } };
  } catch(e){ alert('Screen share failed: '+e.message); }
}

function endCall(){ if(ws&&ws.readyState===WebSocket.OPEN) ws.close(); cleanupPeer(); statusSpan.textContent='Call ended'; if(timerInterval) clearInterval(timerInterval); }
function cleanupPeer(){ if(pc){ try{ pc.close(); } catch(e){} pc=null; } if(remoteVideo && remoteVideo.srcObject){ const s=remoteVideo.srcObject; if(s.getTracks) s.getTracks().forEach(t=>t.stop()); remoteVideo.srcObject=null; } }

startTimer(0);
</script>
<script>
let countdown = 0;
let timerInterval = null;
const timerEl = document.getElementById("timer");

// URL se duration read karo
const urlParams = new URLSearchParams(window.location.search);
const duration = parseInt(urlParams.get("duration")) || 15; // default 15 min
countdown = duration * 60; // convert to seconds

startCountdown();

function startCountdown() {
  if (timerInterval) clearInterval(timerInterval);

  updateTimerDisplay();

  timerInterval = setInterval(() => {
    if (countdown > 0) {
      countdown--;
      updateTimerDisplay();
    } else {
      clearInterval(timerInterval);
      timerEl.textContent = "00:00";
      alert("‚è∞ Meeting time is over. Disconnecting...");
      endCall();
    }
  }, 1000);
}

function updateTimerDisplay() {
  const m = Math.floor(countdown / 60).toString().padStart(2, '0');
  const s = (countdown % 60).toString().padStart(2, '0');
  timerEl.textContent = `${m}:${s}`;
}

// üî¥ Disconnect logic
function endCall() {
  try {
    // Agar WebRTC PeerConnection hai to close karo
    if (window.pc) {
      window.pc.close();
    }

    // Agar localStream chal rahi hai to tracks stop karo
    if (window.localStream) {
      window.localStream.getTracks().forEach(track => track.stop());
    }

    // Agar Firebase room hai to delete karo
    if (window.roomRef) {
      import("https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js")
        .then(({ remove }) => {
          remove(window.roomRef);
        })
        .catch(console.error);
    }
  } catch (err) {
    console.error("Error disconnecting:", err);
  }

  // User ko wapas index.html pe bhejna
  window.location.href = "index.html";
}
</script>

</body>
</html>
